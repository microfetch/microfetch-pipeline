<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="ENA_monitor/overview.html"><strong aria-hidden="true">2.</strong> ENA monitor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ENA_monitor/Installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="ENA_monitor/Workflow.html"><strong aria-hidden="true">2.2.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="ENA_monitor/queued_jobs.html"><strong aria-hidden="true">2.3.</strong> Queued jobs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ENA_monitor/add.html"><strong aria-hidden="true">2.3.1.</strong> Add taxon id (manual)</a></li><li class="chapter-item expanded "><a href="ENA_monitor/data_ready.html"><strong aria-hidden="true">2.3.2.</strong> Mark data ready (callback)</a></li><li class="chapter-item expanded "><a href="ENA_monitor/data_collected.html"><strong aria-hidden="true">2.3.3.</strong> Mark data collected (callback)</a></li></ol></li><li class="chapter-item expanded "><a href="ENA_monitor/event_loop.html"><strong aria-hidden="true">2.4.</strong> Event loop</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ENA_monitor/fetch.html"><strong aria-hidden="true">2.4.1.</strong> Fetch accession numbers</a></li><li class="chapter-item expanded "><a href="ENA_monitor/filter.html"><strong aria-hidden="true">2.4.2.</strong> Filter accession numbers</a></li><li class="chapter-item expanded "><a href="ENA_monitor/droplets.html"><strong aria-hidden="true">2.4.3.</strong> Start droplet farm</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="Data_collector/overview.html"><strong aria-hidden="true">3.</strong> Data collector</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Data_collector/collect.html"><strong aria-hidden="true">3.1.</strong> Collecting data</a></li><li class="chapter-item expanded "><a href="Data_collector/callback.html"><strong aria-hidden="true">3.2.</strong> Signalling data as collected</a></li></ol></li><li class="chapter-item expanded "><a href="errors.html"><strong aria-hidden="true">4.</strong> Errors and problems</a></li><li class="chapter-item expanded "><a href="logs.html"><strong aria-hidden="true">5.</strong> Logs</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="microfetch-pipeline"><a class="header" href="#microfetch-pipeline">microfetch-pipeline</a></h2>
<p>The microfetch-pipeline tracks European Nucleotide Archive entries by taxon identifiers and
retrieves and filters the associated genomic data.
These data are processed on a Digital Ocean droplet and the result fetched by servers at the 
Big Data Institute.</p>
<p>The pipeline has two separate components, the <a href="./ENA_monitor/overview.html">ENA monitor</a> and the 
<a href="./Data_collector/overview.html">Data collector</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ena-monitor"><a class="header" href="#ena-monitor">ENA monitor</a></h1>
<p>The ENA monitor is the main component. 
This program can be given taxon ids to track.
Tracked taxon ids will be serially processed, meaning they are looked up on the ENA database,
the records retrieved and filtered, and the resulting records sent to a Digital Ocean droplet farm for processing.
When processing is complete, the Digital Ocean droplet informs the ENA monitor, which in turn informs the
<a href="ENA_monitor/../Data_collector/overview.html">Data collector</a>. </p>
<p>The overview of the ENA monitor can be seen with the <code>status</code> subcommand:</p>
<pre><code class="language-shell">docker exec microfetch python /app/src/taxon_tracker.py status
</code></pre>
<p>The status presents a summary of the central CSV file. 
For more detailed information you can inspect that file directly (<code>/app/data/microfetch.csv</code>).
It looks like:</p>
<table><thead><tr><th>taxon_id</th><th>last_checked</th><th>last_run_status</th><th>needs_attention</th><th>stage</th><th>stage_name</th><th>priority</th><th>generated_warning</th><th>checkpoint_time</th></tr></thead><tbody>
<tr><td>570</td><td><NA></td><td>in progress</td><td></td><td>3</td><td>filter accession CSV</td><td>3</td><td></td><td>2022-05-03 09:09:51.093475</td></tr>
<tr><td>750</td><td><NA></td><td>error</td><td></td><td>4</td><td>create droplet farm</td><td>0</td><td></td><td>2022-04-22 19:18:43.476658</td></tr>
<tr><td>755</td><td><NA></td><td>error</td><td></td><td>4</td><td>create droplet farm</td><td>0</td><td></td><td>2022-05-03 08:53:01.363596</td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>The ENA monitor is installed as a docker container created with the Dockerfile in the repository.
The installation includes the commands to initialize the program.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="workflow"><a class="header" href="#workflow">Workflow</a></h1>
<p>The ENA monitor's workflow uses two kinds of commands: queued commands and event loop commands.</p>
<p>This is a pictorial version of the workflow:
<img src="ENA_monitor/../img/graph.png" alt="Workflow graph" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="queued-jobs"><a class="header" href="#queued-jobs">Queued jobs</a></h1>
<p>Queued commands are registered in a hidden directory (<code>/app/data/.queue/</code>) as empty files.
These commands are executed at the beginning of each program loop.
The queue is used to avoid conflicts in writing data to the central record file.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-taxon-ids-to-the-tracker"><a class="header" href="#add-taxon-ids-to-the-tracker">Add taxon ids to the tracker</a></h1>
<p>Taxon ids can be added using the <code>add</code> subcommand.
Assuming you have the docker container for the app running as <code>microfetch</code>, 
add taxon ids with the command:</p>
<pre><code class="language-shell">docker exec microfetch python /app/src/taxon_tracker.py add 450 470 570 750
</code></pre>
<p>The above command will add the taxon ids 450, 470, 570, and 750 to tracking.
If you are monitoring the output or logs for the main process,
you'll see those being added before the next <a href="ENA_monitor/event_loop.html">event loop</a> step.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mark-data-ready-callback"><a class="header" href="#mark-data-ready-callback">Mark data ready (callback)</a></h1>
<p>When a Digital Ocean droplet has finished processing the accession numbers assigned to it,
it sends a callback to the ENA monitor via HTTP.
This HTTP request is captured by a minimal webserver and adds a mark data request to the queue.
The command is: </p>
<pre><code>update-droplet-status taxon_id droplet_ip new_status
</code></pre>
<p>In practice it will look something like:</p>
<pre><code>update-droplet-status 450 8.35.22.10 ready
</code></pre>
<p>The ENA monitor simply alters the record for all accession numbers assigned to the droplet to show the given status.
When the <a href="ENA_monitor/../Data_collector/overview.html">Data collector</a> queries the ENA monitor for data ready to collect,
the droplet IPs will be sent back in response.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mark-data-collected-callback"><a class="header" href="#mark-data-collected-callback">Mark data collected (callback)</a></h1>
<p>When the <a href="ENA_monitor/../Data_collector/overview.html">Data collector</a> has collected data from a droplet it
executes a small shell script callback:</p>
<pre><code class="language-shell">python /app/src/taxon_tracker.py mark-collected -t taxon_id -d droplet_ip
</code></pre>
<p>The ENA monitor will then mark the droplet data as collected and destroy the droplet.
If all droplets have had their data collected, the process is complete and 
the ENA monitor will mark the pipeline to start again from the beginning.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="event-loop"><a class="header" href="#event-loop">Event loop</a></h1>
<p>The event loop is a heartbeat script that processes the next job in the loop.
Each taxon id tracked has a job stage and a priority -- 
generally later stages in the update and retrieval process have a higher priority than earlier stages
(meaning taxon ids tend to get processed to completion rather than starting lots of separate threads).
Each job will either update the stage to the next point or trigger activity on remote systems that will
update the stage via a callback.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fetch-accession-numbers"><a class="header" href="#fetch-accession-numbers">Fetch accession numbers</a></h1>
<p>The ENA stores records by 'accession numbers'. 
These numbers are accessed by taxon identifier. 
The first step in the ENA monitor pipeline is to use a taxon id to fetch accession numbers.</p>
<p>The fetching is done via a backend script that uses HTTP requests to the ENA API.
When the API is successfully contacted, it returns a CSV file that is stored as
<code>/app/data/ENA_accession_metadata/&lt;taxon_id&gt;.csv</code>.</p>
<p>This file has the form:</p>
<table><thead><tr><th>experiment_accession</th><th>accession</th><th>sample_accession</th><th>secondary_sample_accession</th></tr></thead><tbody>
<tr><td>ERX1851229</td><td>SAMEA4362422</td><td>SAMEA4362422</td><td>ERS1273871</td></tr>
<tr><td>SRX1972698</td><td>SAMN02256443</td><td>SAMN02256443</td><td>SRS1581087</td></tr>
<tr><td>SRX337460</td><td>SAMN02298051</td><td>SAMN02298051</td><td>SRS471889</td></tr>
<tr><td>SRX346404</td><td>SAMN02344103</td><td>SAMN02344103</td><td>SRS477544</td></tr>
<tr><td>SRX346419</td><td>SAMN02344107</td><td>SAMN02344107</td><td>SRS477553</td></tr>
</tbody></table>
<p>Its contents will be filtered for relevance and quality in the next step.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="filter-accession-numbers"><a class="header" href="#filter-accession-numbers">Filter accession numbers</a></h1>
<p><em>Accession numbers are filtered for relevance.</em></p>
<p>The filtering creates a CSV file that is stored as
<code>/app/data/ENA_accession_filtered/&lt;taxon_id&gt;.csv</code>.</p>
<p>This file has the form:</p>
<table><thead><tr><th>accession</th></tr></thead><tbody>
<tr><td>SAMEA4362422</td></tr>
<tr><td>SAMN02256443</td></tr>
<tr><td>SAMN02298051</td></tr>
<tr><td>SAMN02344103</td></tr>
<tr><td>SAMN02344107</td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-droplet-farm"><a class="header" href="#create-droplet-farm">Create droplet farm</a></h1>
<p>Once the list of accession numbers has been filtered to those that are good candidates for retrieval,
the actual data are pulled down from the ENA using Digital Ocean droplets. 
Filtered accession numbers are divided up among the available droplets, 
and those droplets are initialized and left to run.</p>
<p>The file <code>/app/data/ENA_accession_filtered/&lt;taxon_id&gt;.csv</code> is updated to include droplet metadata:</p>
<table><thead><tr><th>accession</th><th>droplet_group</th><th>droplet_ip</th><th>status</th></tr></thead><tbody>
<tr><td>SAMEA4076733</td><td>0</td><td>127.0.0.1</td><td>processing</td></tr>
<tr><td>SAMEA104200669</td><td>1</td><td>127.0.0.1</td><td>processing</td></tr>
<tr><td>SAMEA4598506</td><td>0</td><td>127.0.0.1</td><td>processing</td></tr>
<tr><td>SAMEA4598507</td><td>1</td><td>127.0.0.1</td><td>processing</td></tr>
</tbody></table>
<p>When the droplets complete, they issue a <a href="ENA_monitor/data_ready.html">data ready callback</a>.</p>
<p>This step will only be run when droplets are available.
If another taxon id is using the droplets, they will not be created until the data have been collected
and the existing droplets destroyed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collector"><a class="header" href="#data-collector">Data collector</a></h1>
<p>The Data collector downloads data from a Digital Ocean droplet and informs the <a href="Data_collector/../ENA_monitor/overview.html">ENA monitor</a>, 
which deactivates the droplet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collection"><a class="header" href="#data-collection">Data collection</a></h1>
<p>The data collector is used because the BDI servers have access/bandwidth limitations.</p>
<p><em>This script will check for droplets awaiting data collection and download the data.
On completion, it will signal to the <a href="Data_collector/../ENA_monitor/overview.html">ENA monitor</a> that the droplets can be destroyed.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collection-callback"><a class="header" href="#data-collection-callback">Data collection callback</a></h1>
<p>When data have been collected from the droplets, 
the collector will instruct the <a href="Data_collector/../ENA_monitor/overview.html">ENA monitor</a> to 
<a href="Data_collector/../ENA_monitor/data_collected.html">mark the data as collected</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="errors-and-problems"><a class="header" href="#errors-and-problems">Errors and problems</a></h1>
<p>When the ENA monitor runs into problems, it logs the errors and stops working with the taxon id that 
generated the error.</p>
<p>A list of the taxon ids that have errored can be viewed with the verbose output of the <code>status</code> subcommand:</p>
<pre><code class="language-shell">docker exec microfetch python /app/src/taxon_tracker.py status -v 1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logs"><a class="header" href="#logs">Logs</a></h1>
<p>The actions of the ENA monitor are recorded in logs. 
If the ENA monitor is started with the verbose flag (<code>-v</code>), the logging will be at DEBUG level,
otherwise it is INFO level.</p>
<p>The main log is found at <code>/app/data/log/main.log</code>, the server log at <code>/app/data/log/server.log</code>,
and the logs for individual taxon ids at <code>/app/data/log/&lt;taxon_id&gt;.log</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
